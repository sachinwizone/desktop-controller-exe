<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote View - Desktop Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #1e1e1e;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #444;
        }

        .system-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .system-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
        }

        .system-details h2 {
            font-size: 18px;
            margin-bottom: 3px;
        }

        .system-details p {
            color: #888;
            font-size: 13px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #1a1a1a;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connecting { background: #f59e0b; }
        .status-dot.connected { background: #22c55e; }
        .status-dot.disconnected { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-info {
            color: #888;
            font-size: 13px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        /* Screen Container */
        .screen-container {
            background: #111;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            max-width: 95%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
        }

        .screen-header {
            background: #1e1e1e;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .screen-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #888;
        }

        .screen-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .control-btn:hover {
            background: #444;
        }

        .control-btn.active {
            background: #06b6d4;
        }

        .screen-view {
            position: relative;
            background: #000;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #remoteScreen {
            max-width: 100%;
            max-height: 70vh;
            display: block;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #333;
            border-top: 4px solid #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .loading-state p {
            color: #888;
            font-size: 14px;
        }

        /* Waiting State */
        .waiting-state {
            text-align: center;
            padding: 60px;
        }

        .waiting-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .waiting-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #f59e0b;
        }

        .waiting-state p {
            color: #888;
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 60px;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .error-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #ef4444;
        }

        .error-state p {
            color: #888;
            font-size: 14px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.3s;
        }

        .retry-btn:hover {
            transform: translateY(-2px);
        }

        /* Stats Bar */
        .stats-bar {
            background: #1e1e1e;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            border-top: 1px solid #333;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
        }

        /* Fullscreen */
        .fullscreen-mode .header,
        .fullscreen-mode .stats-bar {
            display: none;
        }

        .fullscreen-mode .main-content {
            padding: 0;
        }

        .fullscreen-mode .screen-container {
            max-width: 100%;
            border-radius: 0;
            border: none;
        }

        .fullscreen-mode #remoteScreen {
            max-height: 100vh;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goBack()">
                ‚Üê Back
            </button>
            <div class="system-info">
                <div class="system-avatar" id="systemAvatar">?</div>
                <div class="system-details">
                    <h2 id="systemName">Loading...</h2>
                    <p id="systemMeta">Connecting...</p>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <span class="status-dot connecting" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="refresh-info">
                Refresh: <span id="refreshRate">2s</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="screen-container">
            <div class="screen-header">
                <div class="screen-title">
                    <span>üñ•Ô∏è</span>
                    <span id="screenTitle">Remote Desktop</span>
                </div>
                <div class="screen-controls">
                    <button class="control-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                    <button class="control-btn" onclick="refreshNow()">üîÑ Refresh</button>
                </div>
            </div>

            <div class="screen-view" id="screenView">
                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <h3>Connecting to Remote System</h3>
                    <p>Please wait while we establish connection...</p>
                </div>

                <!-- Waiting State -->
                <div class="waiting-state" id="waitingState" style="display: none;">
                    <div class="waiting-icon">üì°</div>
                    <h3>Waiting for Screen Data</h3>
                    <p>The remote system is being notified. Screen capture will appear shortly once the system starts streaming.</p>
                </div>

                <!-- Error State -->
                <div class="error-state" id="errorState" style="display: none;">
                    <div class="error-icon">‚ùå</div>
                    <h3>Connection Failed</h3>
                    <p id="errorMessage">Unable to connect to the remote system.</p>
                    <button class="retry-btn" onclick="startViewing()">üîÑ Retry Connection</button>
                </div>

                <!-- Remote Screen -->
                <img id="remoteScreen" style="display: none;" alt="Remote Screen">
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span>Resolution:</span>
                    <span class="stat-value" id="resolution">-</span>
                </div>
                <div class="stat-item">
                    <span>Last Update:</span>
                    <span class="stat-value" id="lastUpdate">-</span>
                </div>
                <div class="stat-item">
                    <span>Machine ID:</span>
                    <span class="stat-value" id="machineIdDisplay">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const systemId = urlParams.get('system_id');  // The readable ID like "203-760-824"
        const machineId = urlParams.get('machine_id');  // The machine hash ID
        
        let systemInfo = null;
        let refreshInterval = null;
        let isConnected = false;
        let frameCount = 0;

        // Initialize
        if (!systemId && !machineId) {
            showError('No system ID specified');
        } else {
            document.getElementById('machineIdDisplay').textContent = systemId || machineId?.substring(0, 12) + '...';
            loadSystemInfo();
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const response = await fetch(`/api.php?action=get_system_info&machine_id=${encodeURIComponent(machineId || systemId)}`);
                const result = await response.json();

                if (result.success) {
                    systemInfo = result.data;
                    updateSystemDisplay();
                    startViewing();
                } else {
                    showError('System not found: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                showError('Connection error: ' + err.message);
            }
        }

        // Update system display
        function updateSystemDisplay() {
            if (!systemInfo) return;

            const name = systemInfo.display_name || systemInfo.employee_id;
            const initials = name.split(' ').map(w => w[0]).join('').toUpperCase().substring(0, 2);
            
            document.getElementById('systemAvatar').textContent = initials;
            document.getElementById('systemName').textContent = name;
            document.getElementById('systemMeta').textContent = 
                `${systemInfo.company_name} | ${systemInfo.machine_name} | ${systemInfo.ip_address}`;
            document.getElementById('screenTitle').textContent = 
                `${systemInfo.machine_name} - Remote Desktop`;
        }

        // Start viewing session
        async function startViewing() {
            showLoading();
            
            // Use the readable system_id for live_sessions (this is what EXE checks)
            const viewingId = systemInfo?.system_id || systemId;
            
            try {
                // Tell server we're viewing (this creates a session that EXE checks)
                const response = await fetch('/api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'start_viewing',
                        system_id: viewingId,
                        viewer_id: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    setStatus('connected', 'Connected');
                    isConnected = true;
                    
                    // Start fetching frames
                    fetchFrame();
                    refreshInterval = setInterval(fetchFrame, 2000);
                } else {
                    showError('Failed to start viewing: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                showError('Connection error: ' + err.message);
            }
        }

        // Fetch latest frame
        async function fetchFrame() {
            // Use the readable system_id for frames (this is what EXE stores)
            const viewingId = systemInfo?.system_id || systemId;
            
            try {
                const response = await fetch(`/api.php?action=get_live_frame&system_id=${encodeURIComponent(viewingId)}`);
                const result = await response.json();

                if (result.success && result.data && result.data.frame) {
                    showScreen(result.data);
                    frameCount++;
                } else if (result.waiting) {
                    showWaiting();
                }
            } catch (err) {
                console.error('Frame fetch error:', err);
            }
        }

        // Show screen
        function showScreen(data) {
            hideAllStates();
            
            const img = document.getElementById('remoteScreen');
            img.src = 'data:image/jpeg;base64,' + data.frame;
            img.style.display = 'block';
            
            document.getElementById('resolution').textContent = `${data.width} x ${data.height}`;
            document.getElementById('lastUpdate').textContent = formatTime(data.captureTime);
            
            setStatus('connected', 'Live');
        }

        // Show loading
        function showLoading() {
            hideAllStates();
            document.getElementById('loadingState').style.display = 'block';
            setStatus('connecting', 'Connecting...');
        }

        // Show waiting
        function showWaiting() {
            hideAllStates();
            document.getElementById('waitingState').style.display = 'block';
            setStatus('connecting', 'Waiting for stream...');
        }

        // Show error
        function showError(message) {
            hideAllStates();
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            setStatus('disconnected', 'Disconnected');
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Hide all states
        function hideAllStates() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('waitingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('remoteScreen').style.display = 'none';
        }

        // Set status
        function setStatus(status, text) {
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }

        // Format time
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }

        // Refresh now
        function refreshNow() {
            fetchFrame();
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen-mode');
            
            if (document.body.classList.contains('fullscreen-mode')) {
                document.documentElement.requestFullscreen?.();
            } else {
                document.exitFullscreen?.();
            }
        }

        // Go back
        function goBack() {
            const viewingId = systemInfo?.system_id || systemId;
            
            // Stop viewing session
            if (viewingId) {
                fetch('/api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'stop_viewing',
                        system_id: viewingId,
                        viewer_id: 'admin'
                    })
                }).catch(() => {});
            }
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            window.location.href = 'live_systems.html';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            const viewingId = systemInfo?.system_id || systemId;
            if (viewingId) {
                navigator.sendBeacon('/api.php', JSON.stringify({
                    action: 'stop_viewing',
                    system_id: viewingId,
                    viewer_id: 'admin'
                }));
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.body.classList.contains('fullscreen-mode')) {
                    toggleFullscreen();
                }
            }
            if (e.key === 'r' || e.key === 'R') {
                refreshNow();
            }
        });
    </script>
</body>
</html>
